<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapDoc</title>
    <!-- 引入 Tailwind CSS 以便快速构建美观的界面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 JSZip 库用于打包下载 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 引入 jsPDF 库用于生成PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 自定义样式 */
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif';
        }
        /* 打印样式 */
        @media print {
            body > * { display: none; }
            #output-container, #output-container > .page-wrapper { display: block; }
            .page-canvas { 
                page-break-after: always; 
                width: 100% !important; 
                height: auto !important;
                box-shadow: none; 
                border: none; 
            }
            .page-controls, .page-label { display: none; }
        }
        /* 加载动画样式 */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <!-- 头部信息 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">SnapDoc (v4.5)</h1>
            <p class="mt-2 text-gray-600">Commissioned by Jason Liu</p>
        </header>

        <!-- 主操作区域 -->
        <main class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <!-- 步骤一：上传图片 -->
            <div id="upload-section">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">1. Upload Image</h2>
                <div class="flex items-center justify-center w-full">
                    <label for="image-upload" class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-10 h-10 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                            <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">点击上传</span> 或 将文件拖拽至此</p>
                            <p class="text-xs text-gray-500">支持 PNG, JPG, WEBP 等格式</p>
                        </div>
                        <input id="image-upload" type="file" class="hidden" accept="image/*" />
                    </label>
                </div>
            </div>

            <!-- 步骤二：预览与处理 -->
            <div id="preview-section" class="hidden mt-6">
                 <h2 class="text-xl font-semibold mb-4 border-b pb-2">第二步：预览与参数设置</h2>
                 <div class="mb-4">
                    <img id="image-preview" src="#" alt="图片预览" class="max-w-full mx-auto rounded-lg shadow-md" />
                 </div>
                 <div class="grid md:grid-cols-3 lg:grid-cols-5 gap-4 my-6">
                    <div>
                        <label for="a4-ratio-select" class="block mb-2 text-sm font-medium text-gray-900">纸张方向</label>
                        <select id="a4-ratio-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            <option value="1.414" selected>A4 纵向</option>
                            <option value="0.707">A4 横向</option>
                        </select>
                    </div>
                     <div>
                        <label for="margin-top" class="block mb-2 text-sm font-medium text-gray-900">上页边距 (px)</label>
                        <input type="number" id="margin-top" value="50" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                     <div>
                        <label for="margin-bottom" class="block mb-2 text-sm font-medium text-gray-900">下页边距 (px)</label>
                        <input type="number" id="margin-bottom" value="50" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                     <div>
                        <label for="color-tolerance" class="block mb-2 text-sm font-medium text-gray-900">背景色容差</label>
                        <input type="number" id="color-tolerance" value="20" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" title="判断一个像素是否为背景色的容忍度。">
                    </div>
                     <div>
                        <label for="pdf-quality" class="block mb-2 text-sm font-medium text-gray-900">PDF 质量</label>
                        <input type="number" id="pdf-quality" value="0.85" step="0.05" min="0.1" max="1.0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" title="设置导出PDF中图片的压缩质量(0.1-1.0)，值越小文件越小。">
                    </div>
                 </div>
                 <div class="text-center">
                    <button id="process-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 shadow-md">
                        开始智能分页
                    </button>
                 </div>
            </div>
            
            <!-- 加载状态 -->
            <div id="loading-section" class="hidden text-center py-12">
                <div class="loader mx-auto"></div>
                <p id="loading-text" class="mt-4 text-gray-600 font-semibold">正在智能分析和分页，请稍候...</p>
                <p id="progress-text" class="text-sm text-gray-500 mt-2"></p>
            </div>

            <!-- 步骤三：结果与下载 -->
            <div id="result-section" class="hidden mt-8">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">第三步：分页结果与下载</h2>
                <p class="text-gray-600 mb-4">已为您生成 <span id="page-count" class="font-bold text-blue-600"></span> 页。请检查下方预览，然后选择下载或打印。</p>
                <div class="flex justify-center items-center gap-4 mb-6 flex-wrap">
                     <button id="download-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-md">📄 下载为 PDF</button>
                     <button id="download-all-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-md">📦 下载全部分页 (ZIP)</button>
                     <button id="print-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-md">🖨️ 打印全部分页</button>
                </div>
                <div id="output-container" class="space-y-8 bg-gray-200 p-4 rounded-lg"></div>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>&copy; 0xbean. 所有图片处理均在本地完成。</p>
        </footer>
    </div>

    <script>
        // --- DOM 元素获取 ---
        const uploadSection = document.getElementById('upload-section');
        const previewSection = document.getElementById('preview-section');
        const resultSection = document.getElementById('result-section');
        const loadingSection = document.getElementById('loading-section');
        const loadingText = document.getElementById('loading-text');
        const progressText = document.getElementById('progress-text');
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const processBtn = document.getElementById('process-btn');
        const printBtn = document.getElementById('print-btn');
        const downloadAllBtn = document.getElementById('download-all-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const outputContainer = document.getElementById('output-container');
        const pageCountSpan = document.getElementById('page-count');
        const a4RatioSelect = document.getElementById('a4-ratio-select');
        const marginTopInput = document.getElementById('margin-top');
        const marginBottomInput = document.getElementById('margin-bottom');
        const colorToleranceInput = document.getElementById('color-tolerance');
        const pdfQualityInput = document.getElementById('pdf-quality');

        let originalImage = null;
        let originalFileName = '智能分页结果'; // 默认文件名
        let backgroundColor = { r: 255, g: 255, b: 255 };

        // --- 事件监听 ---
        imageUpload.addEventListener('change', handleImageUpload);
        processBtn.addEventListener('click', processImage);
        printBtn.addEventListener('click', () => window.print());
        downloadAllBtn.addEventListener('click', downloadAllAsZip);
        downloadPdfBtn.addEventListener('click', downloadAllAsPdf);

        /**
         * 处理用户上传的图片
         */
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                // 关键改动：存储原始文件名（不含扩展名）
                originalFileName = file.name.replace(/\.[^/.]+$/, "");

                const reader = new FileReader();
                reader.onload = (event) => {
                    originalImage = new Image();
                    originalImage.onload = () => {
                        imagePreview.src = event.target.result;
                        detectBackgroundColor(originalImage);
                        uploadSection.classList.add('hidden');
                        previewSection.classList.remove('hidden');
                        resultSection.classList.add('hidden');
                        outputContainer.innerHTML = '';
                    };
                    originalImage.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        /**
         * 自动检测图片背景色
         */
        function detectBackgroundColor(img) {
            const canvas = document.createElement('canvas');
            const sampleSize = 10;
            canvas.width = sampleSize;
            canvas.height = sampleSize;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, sampleSize, sampleSize, 0, 0, sampleSize, sampleSize);
            
            const imageData = ctx.getImageData(0, 0, sampleSize, sampleSize).data;
            let r = 0, g = 0, b = 0;
            for (let i = 0; i < imageData.length; i += 4) {
                r += imageData[i];
                g += imageData[i + 1];
                b += imageData[i + 2];
            }
            const pixelCount = imageData.length / 4;
            backgroundColor = {
                r: Math.round(r / pixelCount),
                g: Math.round(g / pixelCount),
                b: Math.round(b / pixelCount)
            };
            console.log('检测到的背景色:', backgroundColor);
        }

        /**
         * 核心功能：处理并分页图片
         */
        async function processImage() {
            if (!originalImage) return;

            previewSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');
            loadingText.textContent = '正在智能分析和分页，请稍候...';
            resultSection.classList.add('hidden');
            outputContainer.innerHTML = '';
            await new Promise(resolve => setTimeout(resolve, 50));

            const imgWidth = originalImage.width;
            const imgHeight = originalImage.height;
            const A4_RATIO = parseFloat(a4RatioSelect.value);
            const MARGIN_TOP = parseInt(marginTopInput.value, 10);
            const MARGIN_BOTTOM = parseInt(marginBottomInput.value, 10);
            const COLOR_TOLERANCE = parseInt(colorToleranceInput.value, 10);
            const PAGE_HEIGHT = Math.floor(imgWidth * A4_RATIO);
            
            let currentY = 0;
            const pages = [];
            const analysisCanvas = document.createElement('canvas');
            analysisCanvas.width = imgWidth;
            const analysisCtx = analysisCanvas.getContext('2d', { willReadFrequently: true });

            while (currentY < imgHeight) {
                progressText.textContent = `正在处理... ${Math.round((currentY / imgHeight) * 100)}%`;
                
                let contentHeightLimit;
                if (pages.length === 0) {
                    contentHeightLimit = PAGE_HEIGHT - MARGIN_BOTTOM;
                } else {
                    contentHeightLimit = PAGE_HEIGHT - MARGIN_TOP - MARGIN_BOTTOM;
                }

                if (contentHeightLimit <= 0) {
                    alert('错误：页边距之和不能大于或等于页面总高！请减小页边距。');
                    loadingSection.classList.add('hidden');
                    previewSection.classList.remove('hidden');
                    return;
                }
                
                const maxPossibleEndY = currentY + contentHeightLimit;

                if (maxPossibleEndY >= imgHeight) {
                    pages.push({ startY: currentY, endY: imgHeight });
                    break;
                }
                
                const actualEndY = findBreakPoint(currentY, maxPossibleEndY, imgWidth, COLOR_TOLERANCE, analysisCanvas, analysisCtx);
                
                pages.push({ startY: currentY, endY: actualEndY });
                currentY = actualEndY;
                
                await new Promise(resolve => setTimeout(resolve, 10));
            }

            displayPages(pages, imgWidth, PAGE_HEIGHT, MARGIN_TOP);
            loadingSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
        }

        /**
         * 寻找断点
         */
        function findBreakPoint(blockStartY, maxPossibleEndY, imgWidth, tolerance, canvas, ctx) {
            const searchRange = 300; 
            const searchStartY = Math.max(blockStartY, maxPossibleEndY - searchRange);
            const searchEndY = maxPossibleEndY;
            
            const searchHeight = searchEndY - searchStartY;
            if (searchHeight <= 0) return maxPossibleEndY;

            canvas.height = searchHeight;
            ctx.drawImage(originalImage, 0, searchStartY, imgWidth, searchHeight, 0, 0, imgWidth, searchHeight);
            
            try {
                const imageData = ctx.getImageData(0, 0, imgWidth, searchHeight).data;
                
                for (let y = searchHeight - 1; y > 0; y--) {
                    let isBlankRow = true;
                    for (let x = 0; x < imgWidth; x++) {
                        const i = (y * imgWidth + x) * 4;
                        const r = imageData[i], g = imageData[i+1], b = imageData[i+2];
                        const dist = Math.sqrt(Math.pow(r - backgroundColor.r, 2) + Math.pow(g - backgroundColor.g, 2) + Math.pow(b - backgroundColor.b, 2));
                        if (dist > tolerance) {
                            isBlankRow = false;
                            break;
                        }
                    }
                    
                    if (isBlankRow) {
                        const MIN_BLANK_HEIGHT = 5;
                        let blankHeight = 0;
                        for (let j = y; j >= 0; j--) {
                            let isInnerBlank = true;
                            for (let x = 0; x < imgWidth; x++) {
                                const i = (j * imgWidth + x) * 4;
                                const r = imageData[i], g = imageData[i+1], b = imageData[i+2];
                                const dist = Math.sqrt(Math.pow(r - backgroundColor.r, 2) + Math.pow(g - backgroundColor.g, 2) + Math.pow(b - backgroundColor.b, 2));
                                if (dist > tolerance) {
                                    isInnerBlank = false;
                                    break;
                                }
                            }
                            if(isInnerBlank) {
                                blankHeight++;
                            } else {
                                break;
                            }
                        }

                        if (blankHeight >= MIN_BLANK_HEIGHT) {
                            return searchStartY + y - blankHeight + 1;
                        }
                    }
                }

            } catch (e) {
                console.error("无法获取 Canvas 像素数据", e);
            }

            return maxPossibleEndY; 
        }

        /**
         * 在页面上渲染所有分页后的图片
         */
        function displayPages(pages, imgWidth, pageHeight, marginTop) {
            pageCountSpan.textContent = pages.length;
            outputContainer.innerHTML = '';

            pages.forEach((page, index) => {
                const sliceHeight = page.endY - page.startY;
                const pageCanvas = document.createElement('canvas');
                pageCanvas.width = imgWidth;
                pageCanvas.height = pageHeight;
                pageCanvas.dataset.pageNumber = index + 1;
                pageCanvas.className = 'page-canvas w-full h-auto rounded-lg shadow-md border border-gray-300';
                
                const pageCtx = pageCanvas.getContext('2d');
                
                pageCtx.fillStyle = `rgb(${backgroundColor.r}, ${backgroundColor.g}, ${backgroundColor.b})`;
                pageCtx.fillRect(0, 0, imgWidth, pageHeight);
                
                const destinationY = (index === 0) ? 0 : marginTop;
                pageCtx.drawImage(originalImage, 0, page.startY, imgWidth, sliceHeight, 0, destinationY, imgWidth, sliceHeight);

                const pageWrapper = document.createElement('div');
                pageWrapper.className = 'page-wrapper relative';
                
                const pageLabel = document.createElement('div');
                pageLabel.className = 'page-label absolute top-2 right-2 bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-md';
                pageLabel.textContent = `第 ${index + 1} / ${pages.length} 页`;
                
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'page-controls text-center mt-2';
                
                const downloadLink = document.createElement('a');
                downloadLink.href = '#';
                downloadLink.className = 'bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg inline-block text-sm';
                downloadLink.textContent = '下载本页';
                downloadLink.onclick = (e) => {
                    e.preventDefault();
                    const link = document.createElement('a');
                    link.href = pageCanvas.toDataURL('image/png');
                    // 关键改动：使用原始文件名
                    link.download = `${originalFileName}_${pageCanvas.dataset.pageNumber}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                controlsDiv.appendChild(downloadLink);
                pageWrapper.appendChild(pageCanvas); 
                pageWrapper.appendChild(pageLabel);
                pageWrapper.appendChild(controlsDiv);
                outputContainer.appendChild(pageWrapper);
            });
        }

        /**
         * 将所有分页图片打包成 ZIP 下载
         */
        async function downloadAllAsZip() {
            const canvases = outputContainer.querySelectorAll('canvas.page-canvas');
            if (canvases.length === 0) {
                alert('没有可供下载的页面！');
                return;
            }
            
            const zip = new JSZip();
            loadingSection.classList.remove('hidden');
            loadingText.textContent = '正在打包ZIP文件，请稍候...';
            progressText.textContent = '';
            
            await new Promise(resolve => setTimeout(resolve, 50));

            for (let i = 0; i < canvases.length; i++) {
                const canvas = canvases[i];
                const pageNum = canvas.dataset.pageNumber;
                progressText.textContent = `正在压缩第 ${pageNum} / ${canvases.length} 页...`;
                const base64Data = canvas.toDataURL('image/png').split(',')[1];
                // 关键改动：使用原始文件名
                zip.file(`${originalFileName}_${pageNum}.png`, base64Data, { base64: true });
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            progressText.textContent = '生成ZIP文件中...';
            zip.generateAsync({ type: 'blob' }).then(function(content) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                // 关键改动：使用原始文件名
                link.download = `${originalFileName}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                loadingSection.classList.add('hidden');
            });
        }

        /**
         * 将所有分页图片打包成一个 PDF 下载
         */
        async function downloadAllAsPdf() {
            const { jsPDF } = window.jspdf;
            const canvases = outputContainer.querySelectorAll('canvas.page-canvas');
            if (canvases.length === 0) {
                alert('没有可供下载的页面！');
                return;
            }

            loadingSection.classList.remove('hidden');
            loadingText.textContent = '正在生成PDF文件，请稍候...';
            progressText.textContent = '';
            await new Promise(resolve => setTimeout(resolve, 50));

            const A4_RATIO = parseFloat(a4RatioSelect.value);
            const orientation = A4_RATIO > 1 ? 'p' : 'l'; // 'p' for portrait, 'l' for landscape
            const pdf = new jsPDF(orientation, 'pt', 'a4');

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const PDF_QUALITY = parseFloat(pdfQualityInput.value);

            for (let i = 0; i < canvases.length; i++) {
                const canvas = canvases[i];
                progressText.textContent = `正在添加第 ${i + 1} / ${canvases.length} 页到PDF...`;
                
                const imgData = canvas.toDataURL('image/jpeg', PDF_QUALITY); 
                
                if (i > 0) {
                    pdf.addPage();
                }
                
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);

                await new Promise(resolve => setTimeout(resolve, 10));
            }

            progressText.textContent = '正在保存PDF文件...';
            // 关键改动：使用原始文件名
            pdf.save(`${originalFileName}.pdf`);

            loadingSection.classList.add('hidden');
        }
    </script>
</body>
</html>
